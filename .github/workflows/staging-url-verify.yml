name: Staging URL Verification

on:
  workflow_dispatch:
  schedule:
    # Keep staging alive - run every 20 minutes (Codespaces timeout is 30min idle)
    - cron: '*/20 * * * *'

concurrency:
  group: staging-url-verify
  cancel-in-progress: false

jobs:
  verify-staging:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start Codespace
        id: codespace
        run: |
          CODESPACE_NAME="astradio-staging-759r569pxjpcwrg"
          
          # Start the codespace
          echo "Starting Codespace: $CODESPACE_NAME"
          START_RESPONSE=$(gh api -X POST user/codespaces/$CODESPACE_NAME/start --jq '{state: .state, web_url: .web_url}')
          echo "start_response<<EOF" >> $GITHUB_OUTPUT
          echo "$START_RESPONSE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Wait for codespace to be running
          echo "Waiting for Codespace to be ready..."
          for i in {1..30}; do
            STATE=$(gh api user/codespaces/$CODESPACE_NAME --jq '.state')
            echo "State: $STATE (attempt $i/30)"
            if [ "$STATE" = "Available" ]; then
              echo "Codespace is ready"
              break
            fi
            sleep 2
          done
          
          if [ "$STATE" != "Available" ]; then
            echo "❌ Codespace failed to start"
            exit 1
          fi
          
          # Get codespace details
          CODESPACE_DATA=$(gh api user/codespaces/$CODESPACE_NAME)
          CODESPACE_ID=$(echo "$CODESPACE_DATA" | jq -r '.id')
          
          echo "codespace_id=$CODESPACE_ID" >> $GITHUB_OUTPUT
          echo "codespace_name=$CODESPACE_NAME" >> $GITHUB_OUTPUT

      - name: Forward Port 3000 and Set Public
        id: port
        run: |
          CODESPACE_NAME="${{ steps.codespace.outputs.codespace_name }}"
          
          # Forward port 3000
          echo "Forwarding port 3000..."
          PORT_DATA=$(gh api -X POST user/codespaces/$CODESPACE_NAME/ports \
            -f number=3000 \
            -f visibility=public \
            --jq '{number: .number, public_url: .public_url, visibility: .visibility}')
          
          PUBLIC_URL=$(echo "$PORT_DATA" | jq -r '.public_url')
          
          echo "port_data<<EOF" >> $GITHUB_OUTPUT
          echo "$PORT_DATA" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "public_url=$PUBLIC_URL" >> $GITHUB_OUTPUT
          echo "Port 3000 forwarded: $PUBLIC_URL"

      - name: Start Server in Codespace
        run: |
          CODESPACE_NAME="${{ steps.codespace.outputs.codespace_name }}"
          
          echo "Starting server in Codespace..."
          
          # SSH into codespace and start server
          gh codespace ssh -c $CODESPACE_NAME -R Nickalas-Paul/Astradio_VNEXT << 'EOF' || true
            cd /workspaces/Astradio_VNEXT
            
            # Check if server is already running
            if pgrep -f "node server/index.js" > /dev/null; then
              echo "Server already running"
              exit 0
            fi
            
            # Install dependencies if needed
            if [ ! -d "node_modules" ]; then
              echo "Installing dependencies..."
              npm install
            fi
            
            # Build vNext if needed
            if [ ! -d "dist/vnext" ]; then
              echo "Building vNext..."
              npm run vnext:build
            fi
            
            # Start server bound to 0.0.0.0:3000
            echo "Starting server on 0.0.0.0:3000..."
            HOST=0.0.0.0 PORT=3000 nohup npm start > /tmp/astradio-server.log 2>&1 &
            
            # Wait for server to be ready
            echo "Waiting for server to start..."
            for i in {1..30}; do
              if curl -f http://localhost:3000/health > /dev/null 2>&1; then
                echo "Server is ready"
                exit 0
              fi
              sleep 1
            done
            
            echo "Server failed to start"
            cat /tmp/astradio-server.log
            exit 1
          EOF
          
          # Give server a moment to fully initialize
          sleep 5

      - name: Test Health Endpoint
        id: health
        run: |
          PUBLIC_URL="${{ steps.port.outputs.public_url }}"
          
          echo "Testing /health at $PUBLIC_URL/health"
          
          for i in {1..10}; do
            HEALTH_RESPONSE=$(curl -s -w "\n%{http_code}" "$PUBLIC_URL/health" || echo -e "\n000")
            HTTP_CODE=$(echo "$HEALTH_RESPONSE" | tail -n 1)
            BODY=$(echo "$HEALTH_RESPONSE" | head -n -1)
            
            echo "Attempt $i: HTTP $HTTP_CODE"
            echo "Response: $BODY"
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "✅ Health check passed"
              echo "health_status=200" >> $GITHUB_OUTPUT
              echo "health_body<<EOF" >> $GITHUB_OUTPUT
              echo "$BODY" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            sleep 2
          done
          
          echo "❌ Health check failed after 10 attempts"
          echo "health_status=failed" >> $GITHUB_OUTPUT
          exit 1

      - name: Test Readyz Endpoint
        id: readyz
        run: |
          PUBLIC_URL="${{ steps.port.outputs.public_url }}"
          
          echo "Testing /readyz at $PUBLIC_URL/readyz"
          
          for i in {1..10}; do
            READYZ_RESPONSE=$(curl -s -w "\n%{http_code}" "$PUBLIC_URL/readyz" || echo -e "\n000")
            HTTP_CODE=$(echo "$READYZ_RESPONSE" | tail -n 1)
            BODY=$(echo "$READYZ_RESPONSE" | head -n -1)
            
            echo "Attempt $i: HTTP $HTTP_CODE"
            echo "Response: $BODY"
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "✅ Readyz check passed"
              echo "readyz_status=200" >> $GITHUB_OUTPUT
              echo "readyz_body<<EOF" >> $GITHUB_OUTPUT
              echo "$BODY" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            sleep 2
          done
          
          echo "❌ Readyz check failed after 10 attempts"
          echo "readyz_status=failed" >> $GITHUB_OUTPUT
          exit 1

      - name: Post Results
        if: always()
        run: |
          PUBLIC_URL="${{ steps.port.outputs.public_url }}"
          HEALTH_STATUS="${{ steps.health.outputs.health_status }}"
          READYZ_STATUS="${{ steps.readyz.outputs.readyz_status }}"
          
          echo "## Staging URL Verification Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Public URL:** $PUBLIC_URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Health Check" >> $GITHUB_STEP_SUMMARY
          if [ "$HEALTH_STATUS" = "200" ]; then
            echo "✅ **GET /health:** 200 OK" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.health.outputs.health_body }}" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **GET /health:** FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Readyz Check" >> $GITHUB_STEP_SUMMARY
          if [ "$READYZ_STATUS" = "200" ]; then
            echo "✅ **GET /readyz:** 200 OK" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.readyz.outputs.readyz_body }}" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **GET /readyz:** FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Set staging URL as output for reuse
          echo "STAGING_URL=$PUBLIC_URL" >> $GITHUB_ENV

